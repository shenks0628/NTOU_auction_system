<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Comment component implementation</title>
    <!-- <link type="text/css" rel="stylesheet" href="comment.css"> -->
    <style>
        body, html{
            background-color: rgb(0, 0, 0, 0.05);
            position: absolute;
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        dt, dd, dl{
            margin: 0;
            padding: 0;
        }
        dt, dd{
            font-weight: 500;
            display: inline-block;
        }
        textarea{
            width: 820px; height: 50px; resize: none
        }
        #button_submit_div > div > button{
            border: none;
            background: red;
            color: white;
            padding: 4px 10px;
        }
        #button_submit_div{
            text-align: right;
        }
        .time{
            padding: 0 10px;
            color: lightgray;
        }
        ul{
            list-style: none;
            padding: 0;
        }
        ul > li:hover{
            background: deepskyblue;
            cursor: pointer;
        }
        ul > li{
            padding: 10px 10px;
            border-bottom: solid 0.5px lightgray;
            display: block;
        }
        ul > li:last-child{
            border-bottom: none;
        }
        .cmt_img, .right_box{
            display: inline-block;
            vertical-align: middle;
        }
        .avatar{
            display:block;
        }
        aside, main{
            background: white;
            vertical-align: top;
            margin-top: 50px;
            box-shadow: 2px 0 2px 0 lightgray;
            display: inline-block;
        }
        aside{
            margin-left: 20px;
            text-align: center;
            width: 300px;
        }
        main{
            padding: 20px 20px 20px 20px;
            text-align: left;
            width: 900px;
        }
        .form_item{
            padding: 10px 0;
        }
        .menu > div{
            display: inline-block;
            padding: 10px 10px;
        }
        .menu > div:hover{
            background: deepskyblue;
            cursor: pointer;
        }
        .menu{
            margin: 0;
            padding: 0;
            background: white;
            position: absolute;
            width: 100%;
            text-align: left;
        }
        input, textarea{
            border: solid 0.5px lightgray;
            border-radius: 3px;
        }
        input{
            padding: 4px 4px;
            height: 30px;
        }
        textarea{
            padding: 10px;
            height: 60px;
        }
        .center-div {
            text-align: center;
            margin: 20px 10px 10px 10px;
            padding: 10px 10px 10px 10px;
        }
        .rating {
            font-size: 20px;
            cursor: pointer;
        }

        .star {
            display: inline-block;
            margin-right: 5px;
        }

        .star:hover,.star.active {
            color: gold;
        }
    </style>
    
</head>

<body>
<div class="menu">
    <div>首頁</div>
    <div>商品</div>
    <div>競標活動</div>
    <div>你的評論</div>
</div>

<div class="center-div">
    <main onclick="mainCLick(event)" style="text-align: left">
        <div id="comment_view"></div>
        <hr/>
        <div class="rating" onclick="handleRating(event)">
            <label>喜好程度：</label>
            <span class="star" data-value="1">&#9733;</span>
            <span class="star" data-value="2">&#9733;</span>
            <span class="star" data-value="3">&#9733;</span>
            <span class="star" data-value="4">&#9733;</span>
            <span class="star" data-value="5">&#9733;</span>
        </div>
        <div class="form_item">
            <label>姓名：</label>
            <input id="commentator" placeholder="請輸入你的名稱"/>
        </div>
        
        <div class="form_item">
            <label class="label_img">
                <img src="avatar.png" width="50px" style="border-radius: 25%;">
            </label>
            <textarea id="comment_space"
                  onkeyup="readKey(event)"
                  onclick="commentFocus(event)"
                  placeholder="請輸入你要評論的內容">
            </textarea>
        </div>
        <div style="float: right">
        <button id="cancel_reply" onclick="cancelReply(event, this)" style="margin-right: 10px;">取消回覆</button>
        <button id="submit_button" style="grid: right;">提交</button>
        <div id="button_submit_div"></div>
        </div>
    </main>
</div>

<script type="text/javascript">

    getRandomId = function () {
        return 'id'.concat(Math.floor((Math.random(10) * 10000000000000000)).toString());
    };
    getCurrentTime = function () {
        return new Date().toLocaleString();
    };
 
    var curReplyTargetTag = null;
    
    var curArr = null;
 
    var parentId = null;
 
    var commentList = [];
 
    var commentTree = {
        id:'',
        commentator: '',
        author: '',
        comment: '',
        time: '',
        reply: []
    };
 
    window.onload = function (ev) {
        // the function will be called at first while page loads
        initTreeComment();
    };
 
    initTreeComment = function () {
        var commentView = document.getElementById('comment_view');
        if (commentList.length === 0) {
            noComment(commentView)
        } else {
            haveComment(commentView, commentList)
        }
    };
 
    noComment = function (commentView) {
        commentView.style.textAlign = 'center';
        commentView.innerText = '目前無任何評論';
    };
 
    commentFocus = function (ev) {
        ev.stopPropagation();
        document.getElementById('comment_space').focus();
        renderReplyBar();
    };
 
    renderReplyBar = function () {
 
        var commentSpace = document.getElementById('comment_space');
        var textareaLen = commentSpace.value.length;
 
        var htmlText ='';
        
        document.getElementById('button_submit_div').innerHTML = htmlText;
 
        submitComment(commentSpace);
    };
 
    submitTree = function (submitButton, textareaEle) {
 
        submitButton.onclick = function (ev) {
            ev.stopPropagation();
            console.log(parentId);
            var text = textareaEle.value;
            if (text.length > 0){
                var plcHolder = textareaEle.placeholder;
                if(plcHolder.charAt(0) === '回') {
                    plcHolder = plcHolder.substring(plcHolder.indexOf(' '), plcHolder.length)
                } else {
                    curArr = commentList;
                    plcHolder = "anonymous";
                }
                var commentator = document.getElementById('commentator').value;
 
                if(commentator.trim().length === 0) {
                    alarmIfEmpSpace();
                } else {
                    commentTree = {
                        id: getRandomId(),
                        commentator: commentator,
                        author: plcHolder,
                        comment: text,
                        time: getCurrentTime(),
                        reply: []
                    };
                    curArr.push(commentTree);
                    initTreeComment();
                    document.getElementById("comment_space").value="";
                    document.getElementById("comment_space").placeholder="請輸入您要評論的內容";
                }
            } else {
                alarmIfEmpSpace();
            }
            
        }
 
    };
 
    alarmIfEmpSpace = function () {
        alert("Nothing worse than itself!")
    };
 
    submitComment = function (textarea) {
        var submitButton = document.getElementById('submit_button');
        submitTree(submitButton, textarea);
    };
 
    cancelReply = function (ev, th) {
        ev.stopPropagation();
        parentId = null;
        document.getElementById('comment_space').value = "";
        document.getElementById('comment_space').placeholder = "請輸入您要評論的內容";
 
    };
 
 
    readKey = function (ev) {
        var space = document.getElementById('comment_space');
        document.getElementById('char_count').innerText = 1000 - space.value.length;
    };
 
 
    commentBlur = function () {
        document.getElementById('button_submit_div').innerHTML = ''
    };
 
    haveComment = function (commentView, arr) {
 
        commentView.style.textAlign = 'left';
 
        var htmlText = '';
        arr.forEach(function (value) {
            htmlText +=
                '<ul id="'+ value.id +'" class="comment_ulist" style="">' +
                '  <li class="comment_line_box" id="'+ value.id.substring(0, 4) +'">' +
                '    <a class="cmt_img">' +
                '      <img class="avatar" src="avatar.png" width="30px" style="border-radius: 100%">' +
                '    </a>' +
                '    <div class="right_box">' +
                '      <a class="commentator">'+ value.commentator +'</a>';
 
            if (value.author !== 'anonymous') {
                htmlText +=
                    '<span style="margin: 0 10px;color: lightgray">回覆</span>' +
                    '<a class="author">'+ value.author +'</a>';
            }
 
            htmlText += '<span class="time">'+ value.time +'</span>';
 
            if (value.comment.length > 10){
                htmlText += ' <span style="display: block; margin-top: 8px" class="comment">'+ value.comment+'</span>';
            } else {
                htmlText += ' <span class="comment">'+ value.comment.substring(0, 10) +'</span>';
            }
 
            htmlText +=
                '  </div>' +
                '  <span style="float: right;" id="'+ value.id.substring(0, 7) +'">' +
                '<a id="'+ value.id.substring(0, 5) +'"' +
                '  style="border: none;display: none;margin-right: 10px;">' +
                '回覆</a>';
 
            if(value.reply.length > 0) {
                htmlText += '<a id="'+ value.id.substring(0, 6) +'"' +
                            '         style="border: none;">' +
                            '  查看回覆('+ value.reply.length +')</a></span></li></ul>'
            } else {
                htmlText += '</span></li></ul>';
            }
 
        });
 
        commentView.innerHTML = htmlText;
 
        showButton(arr, 1)
    };
 
    showButton = function (arr, sign) {
 
        arr.forEach(function (value) {
 
            var parent = document.getElementById(value.id);
            var broEle = document.getElementById(value.id.substring(0, 4));
            var checkReply = document.getElementById(value.id.substring(0, 6));
            var reply = document.getElementById(value.id.substring(0, 5));
 
            broEle.onmouseover = function (ev) {
                reply.style.display = 'inline-block';
            };
 
            reply.onclick = function (ev) {
                ev.stopPropagation();
                renderReplyBar();
                curReplyTargetTag = parent;
                if(sign === 1) {
                    parentId = value.id
                    curArr = value.reply;
                } else {
                    curArr = arr;
                }
                document.getElementById('cancel_reply').style.display = 'inline-block';
                var str = "回覆 ".concat(value.commentator);
                fillPlaceholderOfCommentSpace(str)
            };
 
            if (value.reply.length > 0) {
 
                checkReply.onclick = function (ev) {
                    ev.stopPropagation();
                    if(checkReply.innerText.trim().charAt(0) === '查'){
                        ifHaveReply(parent, value.reply, broEle);
                        checkReply.innerText = "收起回覆";
                    } else {
                        toggleBackReplies(parent);
                        checkReply.innerText = "查看回覆("+ value.reply.length +")";
                    }
                };
            }
 
            broEle.onmouseleave = function (ev) {
                reply.style.display = 'none'
            };
        });
    };
 
    toggleBackReplies = function (parentTag) {
        var nodes = parentTag.childNodes;
        var len = nodes.length;
        parentTag.removeChild(nodes[len-1]);
    };
 
    ifHaveReply = function (parentTag, arr, broEle) {
 
        var li = document.createElement("li");
        li.className = "reply_list";
        li.style.marginLeft = '42px';
        li.style.borderLeft = 'solid 5px lightgray';
 
        var htmlText = '<ul class="comment_ulist">';
 
        arr.forEach(function (value) {
            htmlText +=
                '<li class="comment_line_box" id="'+ value.id.substring(0, 4) +'"><a class="cmt_img" style="margin-left: 10px">' +
                '  <img class="avatar" src="avatar.png" width="30px" style="border-radius: 100%">' +
                '</a>' +
                '<div class="right_box">' +
                '  <a class="commentator">'+ value.commentator +'</a>' +
                '  <span style="margin: 0 10px;color: lightgray">回覆</span>' +
                '  <a class="author">'+ value.author +'</a>' +
                '  <span class="time">'+ value.time +'</span>';
 
            if (value.comment.length > 10){
                htmlText += ' <span style="display: block; margin-top: 8px" class="comment">'+ value.comment +'</span>';
            } else {
                htmlText += ' <span class="comment">'+ value.comment.substring(0, 10) +'</span>';
            }
 
            htmlText +=
                '</div>' +
                '<span style="float: right;" id="'+ value.id.substring(0, 7) +'">' +
                '<a id="'+ value.id.substring(0, 5) +'"' +
                '        style="display: none;border: none;margin-right: 10px;">' +
                '回覆</a>';
 
 
            if(value.reply.length > 0) {
                console.log(value.reply.length)
                htmlText += '<a id="'+ value.id.substring(0, 6) +'"' +
                            '         style="border: none;">' +
                            '查看回覆('+ value.reply.length +')</a></span></li>'
            } else {
                htmlText += '</span></li>';
            }
        });
 
        htmlText += '</ul>';
        li.innerHTML = htmlText;
        parentTag.insertBefore(li, broEle.nextSibling);
        showButton(arr, 2)
    };
 
    fillPlaceholderOfCommentSpace = function (str) {
        document.getElementById('comment_space').placeholder = str;
    };
 
    mainCLick = function (ev) {
        document.getElementById('button_submit_div').innerHTML = '';
    };

    function handleRating(event) {
        if (event.target.classList.contains('star')) {
            const value = event.target.getAttribute('data-value');
            resetRating();
            highlightStars(value);
        }
    }

    function resetRating() {
        const stars = document.querySelectorAll('.star');
        stars.forEach(star => star.classList.remove('active'));
    }

    function highlightStars(value) {
        const stars = document.querySelectorAll('.star');
        stars.forEach((star, index) => {
            if (index < value) {
            star.classList.add('active');
            }
        });
    }

</script>
<script src = "test1.js" type = "module"></script>
</body>
</html>